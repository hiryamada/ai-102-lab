#!meta

{"kernelInfo":{"defaultKernelName":"csharp","items":[{"name":"csharp"},{"name":"fsharp","languageName":"F#","aliases":["f#","fs"]},{"name":"html","languageName":"HTML"},{"name":"http","languageName":"HTTP"},{"name":"javascript","languageName":"JavaScript","aliases":["js"]},{"name":"mermaid","languageName":"Mermaid"},{"name":"pwsh","languageName":"PowerShell","aliases":["powershell"]},{"name":"value"}]}}

#!csharp

Console.WriteLine("hello from C#");

#!pwsh

Write-Host "hello from PowerShell"

#!pwsh

#!set --name username --value @input:"Azure portal用のユーザー名を入力してください"

#!pwsh

#!set --name password --value @input:"Azure portal用のパスワードを入力してください"

#!pwsh

az login -u "$username" -p "$password"

#!pwsh

$group = az group list --query "[].name" -o tsv
$group

#!pwsh

$suffix = "lab" + (Get-Random -Minimum 10000000 -Maximum 99999999)
$suffix

#!pwsh

$oainame = "oai" + $suffix
$storagename = "stor" + $suffix
$aisearchname = "aisearch" + $suffix
$location = "eastus"

#!pwsh

az search service create -n $aisearchname -g $group -l $location `
    --sku free --identity-type SystemAssigned

#!pwsh

$mid = (az search service show -n $aisearchname -g $group --query identity.principalId -otsv)

#!pwsh

az cognitiveservices account create `
  -n $oainame -g $group -l $location --kind "OpenAI" --sku "S0" --custom-domain $oainame

#!pwsh

$rid = (az cognitiveservices account show -n $oainame -g $group --query id -otsv)

#!pwsh

az role assignment create `
    --assignee-object-id $mid `
    --assignee-principal-type ServicePrincipal `
    --role "Cognitive Services OpenAI User" `
    --scope $rid

#!pwsh

az cognitiveservices account deployment create `
    -g $group `
    -n $oainame `
    --deployment-name gpt-4o `
    --model-name gpt-4o `
    --model-version 2024-05-13 `
    --model-format OpenAI `
    --sku-name "Standard" `
    --sku-capacity 5

#!pwsh

az cognitiveservices account deployment create `
    -g $group `
    -n $oainame `
    --deployment-name text-embedding-ada-002 `
    --model-name text-embedding-ada-002 `
    --model-version 2 `
    --model-format OpenAI `
    --sku-name "Standard" `
    --sku-capacity 5

#!pwsh

az storage account create -n $storagename -g $group -l $location `
  --sku Standard_LRS --kind StorageV2

#!pwsh

$rid = (az storage account show -n $storagename -g $group --query id -otsv)

#!pwsh

az role assignment create `
    --assignee-object-id $mid `
    --assignee-principal-type ServicePrincipal `
    --role "Storage Blob Data Contributor" `
    --scope $rid

#!pwsh

$stkey = (az storage account keys list --account-name $storagename -g $group `
    --query "[?keyName=='key1'].value | [0]" -o tsv)

#!pwsh

az storage container create --name brochures --account-name $storagename --auth-mode key --account-key $stkey

#!pwsh

az storage blob upload-batch --account-name $storagename --account-key $stkey `
  --source brochures --destination brochures

#!html

<p>ここで、Edge Webブラウザーを開き、Azure portalに移動し、Azure AI Search でベクトルインデックスを作成します。手順は以下を参照してください。</p>
<p>インデックス名は `margies-index` としてください。</p>
<p>
<a href="https://microsoftlearning.github.io/mslearn-openai.ja-jp/Instructions/Exercises/02-use-own-data.html#%E3%82%A4%E3%83%B3%E3%83%87%E3%83%83%E3%82%AF%E3%82%B9%E3%82%92%E4%BD%9C%E6%88%90%E3%81%99%E3%82%8B">インデックスを作成する</a>
</p>

#!pwsh

$env:SEARCH_ENDPOINT = "https://$aisearchname.search.windows.net"
$env:SEARCH_ENDPOINT

#!pwsh

$env:SEARCH_KEY = (az search admin-key show --service-name $aisearchname -g $group --query "primaryKey" -o tsv)
$env:SEARCH_KEY

#!pwsh

$env:SEARCH_INDEX = "margies-index"
$env:SEARCH_INDEX

#!pwsh

$env:OPENAI_ENDPOINT = "https://$oainame.openai.azure.com/"
$env:OPENAI_ENDPOINT

#!pwsh

$env:OPENAI_KEY = (az cognitiveservices account keys list --name $oainame -g $group --query "key1" -o tsv)
$env:OPENAI_KEY

#!pwsh

$env:OPENAI_DEPLOY_NAME = "gpt-4o"
$env:OPENAI_DEPLOY_NAME

#!pwsh

# 以上でセットアップは完了です。プログラムを実行します。

dotnet run
